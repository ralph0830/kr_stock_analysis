# Docker Compose Production Overrides
# =============================================================================
# 운영 환경용 오버라이드 설정
#
# 사용법:
#   docker compose --profile prod up -d
# =============================================================================

services:
  # API Gateway - Production (optimized)
  api-gateway:
    build:
      target: production
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    command: ["uvicorn", "services.api_gateway.main:app", "--host", "0.0.0.0", "--port", "5111"]
    # No volumes for production

  # VCP Scanner - Production (optimized)
  vcp-scanner:
    build:
      target: production
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    command: ["uvicorn", "services.vcp_scanner.main:app", "--host", "0.0.0.0", "--port", "5112"]

  # Signal Engine - Production (optimized)
  signal-engine:
    build:
      target: production
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    command: ["uvicorn", "services.signal_engine.main:app", "--host", "0.0.0.0", "--port", "5113"]

  # Chatbot - Production (optimized)
  chatbot:
    build:
      target: production
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    command: ["uvicorn", "services.chatbot.main:app", "--host", "0.0.0.0", "--port", "5114"]

  # Frontend - Production (optimized build)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: production
    environment:
      - NEXT_PUBLIC_API_URL=${PUBLIC_API_URL:-http://localhost:5111}
      - NEXT_PUBLIC_WS_URL=${PUBLIC_WS_URL:-ws://localhost:5111}
      - NODE_ENV=production
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    # No volumes for production

  # Celery Worker - Production
  celery-worker:
    build:
      target: production
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - CELERY_WORKER_PREFETCH_MULTIPLIER=4
      - CELERY_WORKER_MAX_TASKS_PER_CHILD=1000
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    command: [
      "celery", "-A", "tasks.celery_app", "worker",
      "--loglevel=info",
      "--concurrency=4",
      "--max-tasks-per-child=1000"
    ]

  # Celery Beat - Production
  celery-beat:
    build:
      target: production
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 32M

  # Flower - Production (with basic auth)
  flower:
    environment:
      - FLOWER_BASIC_AUTH=${FLOWER_USER:-admin}:${FLOWER_PASSWORD:-admin}
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 32M

  # PostgreSQL - Production (resource limits)
  postgres:
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Redis - Production (resource limits)
  redis:
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
