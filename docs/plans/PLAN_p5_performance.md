# P5: 성능 최적화 계획

> **생성일**: 2026-01-28
> **상태**: 계획 중
> **범위**: Medium (8-15시간 예상)

---

## 개요

시스템의 전반적인 성능을 최적화하여 사용자 경험을 개선하고 리소스 사용 효율을 높입니다.

### 목표
- API 응답 시간 P95 < 500ms, P99 < 1000ms 달성
- 데이터베이스 Slow Query 90% 감소
- Redis 캐시 적중률 80% 이상 달성
- Celery 태스크 처리량 2배 향상

---

## Phase 1: 데이터베이스 쿼리 튜닝 (2-3시간)

### 목표
Slow Query를 식별하고 인덱스를 최적화하여 쿼리 성능을 개선합니다.

### 작업 항목
- [ ] **1.1 Slow Query 로그 설정**
  - [ ] `log_min_duration_statement` 설정 (100ms)
  - [ ] `pg_stat_statements` 확장 활성화
  - [ ] 자동 로그 분석 스크립트 작성

- [ ] **1.2 인덱스 최적화**
  - [ ] `DailyPrice` 테이블 복합 인덱스 (ticker, date)
  - [ ] `Signal` 테이블 status 인덱스
  - [ ] `InstitutionalFlow` 테이블 date 인덱스
  - [ ] 미사용 인덱스 식별 및 제거

- [ ] **1.3 N+1 쿼리 해결**
  - [ ] 종목 상세 API 로그 분석
  - [ ] `selectinload()` 전략 적용
  - [ ] 배치 조회로 단일 쿼리 변환

### Quality Gate
- [ ] Slow Query < 10개/일
- [ ] 주요 API 응답 시간 30% 이상 개선
- [ ] `EXPLAIN ANALYZE`로 모든 쿼리 확인

---

## Phase 2: Redis 캐시 전략 확장 (2-3시간)

### 목표
Redis 캐시 적중률을 높이고 TTL을 최적화하여 데이터베이스 부하를 줄입니다.

### 작업 항목
- [ ] **2.1 캐시 TTL 최적화**
  - [ ] 주가 데이터: 1분 → 30초 (실시간성)
  - [ ] 시그널 데이터: 5분 → 10분 (변동 적음)
  - [ ] 종목 기본 정보: 1시간 (변경 드묾음)

- [ ] **2.2 캐시 Warm-up**
  - [ ] 애플리케이션 시작 시 인기 종목 미리 로드
  - [ ] `refresh_cache` Celery 태스크 구현
  - [ ] 캐시 적중률 모니터링 엔드포인트

- [ ] **2.3 캐시 적중률 모니터링**
  - [ ] `@cached` 데코레이터에 hit/miss 카운터 추가
  - [ ] `GET /api/system/cache-stats` 엔드포인트
  - [ ] 적중률 80% 미만 알림

### Quality Gate
- [ ] 캐시 적중률 ≥ 80%
- [ ] 데이터베이스 조회 수 50% 감소
- [ ] 캐시 메모리 사용량 < 500MB

---

## Phase 3: API 응답 시간 모니터링 (2-3시간)

### 목표
요청 추적 ID를 활용하여 느린 엔드포인트를 식별하고 모니터링합니다.

### 작업 항목
- [ ] **3.1 요청 추적 ID 활용**
  - [ ] 모든 응답에 X-Request-ID 헤더 포함
  - [ ] 로그에서 request_id로 전체 흐름 추적
  - [ ] Jaeger/Zipkin 형식 추적 데이터 (선택)

- [ ] **3.2 P95/P99 지표 수집**
  - [ ] Prometheus 메트릭에 히스토그램 추가
  - [ ] `api_request_duration_seconds` 메트릭
  - [ ] 엔드포인트별 레이블 (path, method, status)

- [ ] **3.3 느린 엔드포인트 식별**
  - [ ] `/api/kr/stocks/{ticker}/chart` 최적화
  - [ ] `/api/kr/signals` 배치 사이즈 최적화
  - [ ] `/api/kr/ai-analysis` 결과 캐싱

### Quality Gate
- [ ] P95 < 500ms 달성
- [ ] P99 < 1000ms 달성
- [ ] 느린 엔드포인트 3개 이상 개선

---

## Phase 4: 비동기 처리 최적화 (2-4시간)

### 목표
Celery 태스크 처리량을 늘리고 병렬화를 통해 전체 처리 시간을 줄입니다.

### 작업 항목
- [ ] **4.1 Celery 태스크 병렬화**
  - [ ] VCP 스캔 태스크를 종목별로 분할
  - [ ] `group()`와 `chord()` 활용
  - [ ] 실패 시 재시도 정책 구체화

- [ ] **4.2 워커 수 동적 조정**
  - [ ] Celery autoscale 설정
  - [ ] `--autoscale=10,2` (최소 2, 최대 10)
  - [ ] CPU/메모리 사용량 기반 스케일링

- [ ] **4.3 태스크 우선순위**
  - [ ] 실시간 태스크: high 큐
  - [ ] 일괄 처리 태스크: low 큐
  - [ ] 태스크 라우팅 설정

### Quality Gate
- [ ] VCP 스캔 시간 50% 감소
- [ ] Celery 태스크 처리량 2배 향상
- [ ] 태스크 실패율 < 1%

---

## 리스크 평가

| 리스크 | 확률 | 영향 | 완화 전략 |
|--------|------|------|------------|
| 인덱스 추가로 쓰기 성능 저하 | Medium | Medium | 부하가 낮은 시간에 적용 |
| 캐시 무효화로 DB 부하 급증 | Low | High | 캐시 서키브레이커 |
| Celery 워커 스케일링 실패 | Low | Medium | 모니터링과 수동 복구 |

---

## 롤백 전략

### Phase 1
- 인덱스: `DROP INDEX CONCURRENTLY`
- 설정: `postgresql.conf` 롤백

### Phase 2
- TTL 변경: 재배포로 이전 값 복원
- Warm-up: Celery 태스크 비활성화

### Phase 3 & 4
- 메트릭: 추가된 Prometheus 레이블 제거
- 태스크: 기존 태스크 구조로 롤백

---

## 진행 상황

- [ ] Phase 1: 데이터베이스 쿼리 튜닝
- [ ] Phase 2: Redis 캐시 전략 확장
- [ ] Phase 3: API 응답 시간 모니터링
- [ ] Phase 4: 비동기 처리 최적화

---

## 메모

```
마지막 업데이트: 2026-01-28
상태: 계획 승인 대기
```
