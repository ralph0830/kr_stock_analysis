# Docker Compose Development Overrides
# =============================================================================
# 개발 환경용 오버라이드 설정
#
# 사용법:
#   docker compose --profile dev up -d
# =============================================================================

services:
  # API Gateway - Development (hot reload)
  api-gateway:
    env_file:
      - .env
    build:
      target: development
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app:/app/services/api_gateway
    volumes:
      - /home/ralph/work/python/kr_stock_analysis/services/api_gateway:/app/services/api_gateway:ro
      - /home/ralph/work/python/kr_stock_analysis/src:/app/src:ro
    command: ["sh", "-c", "PYTHONPATH=/app:/app/services/api_gateway uvicorn main:app --host 0.0.0.0 --port 5111 --reload"]

  # VCP Scanner - Development (hot reload)
  vcp-scanner:
    env_file:
      - .env
    build:
      target: development
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app/services/vcp_scanner
    volumes:
      - /home/ralph/work/python/kr_stock_analysis/services/vcp_scanner:/app/services/vcp_scanner:ro
      - /home/ralph/work/python/kr_stock_analysis/src:/app/src:ro
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "5112", "--reload"]

  # Signal Engine - Development (hot reload)
  signal-engine:
    env_file:
      - .env
    build:
      target: development
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app/services/signal_engine
    volumes:
      - /home/ralph/work/python/kr_stock_analysis/services/signal_engine:/app/services/signal_engine:ro
      - /home/ralph/work/python/kr_stock_analysis/src:/app/src:ro
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "5113", "--reload"]

  # Chatbot - Development (hot reload)
  chatbot:
    env_file:
      - .env
    build:
      target: development
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app/services/chatbot
    volumes:
      - /home/ralph/work/python/kr_stock_analysis/services/chatbot:/app/services/chatbot:ro
      - /home/ralph/work/python/kr_stock_analysis/src:/app/src:ro
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "5114", "--reload"]

  # Frontend - Development (hot reload)
  frontend:
    ports:
      - "5110:5110"
    # 환경 변수를 설정하지 않고 코드에서 동적으로 결정 (외부 도메인 지원)
    volumes:
      - /home/ralph/work/python/kr_stock_analysis/frontend:/app
      - /app/node_modules
      - /app/.next

  # Celery Worker - Development
  celery-worker:
    env_file:
      - .env
    image: celery-worker:dev
    build:
      context: /home/ralph/work/python/kr_stock_analysis/
      dockerfile: Dockerfile.worker
    command: ["celery", "-A", "tasks.celery_app", "worker", "--loglevel=info"]
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
    volumes:
      - /home/ralph/work/python/kr_stock_analysis/tasks:/app/tasks:ro
      - /home/ralph/work/python/kr_stock_analysis/src:/app/src:ro

  # Celery Beat - Development
  celery-beat:
    env_file:
      - .env
    image: celery-worker:dev
    build:
      context: /home/ralph/work/python/kr_stock_analysis/
      dockerfile: Dockerfile.worker
    command: ["celery", "-A", "tasks.celery_app", "beat", "--loglevel=info"]
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
    volumes:
      - /home/ralph/work/python/kr_stock_analysis/tasks:/app/tasks:ro
      - /home/ralph/work/python/kr_stock_analysis/src:/app/src:ro

  # Flower - Development (enable debug UI)
  flower:
    environment:
      - FLOWER_DEBUG=1
