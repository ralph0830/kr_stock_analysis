# docker/compose/docker-compose.dev.yml
# Ralph Stock - Docker Compose Development 환경
# 사용법: docker compose -f docker/compose/docker-compose.dev.yml up -d

services:
  # ---------------------------------------------------------------------------
  # Application Services (Development)
  # ---------------------------------------------------------------------------

  # API Gateway - Development
  api-gateway:
    build:
      context: ../..
      dockerfile: services/api_gateway/Dockerfile
      target: development
    env_file:
      - ../../.env
    volumes:
      - ../../src:/app/src:ro
      - ../../services:/app/services:ro
      - ../../data:/app/data
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "5111", "--reload"]
    restart: unless-stopped

  # VCP Scanner - Development
  vcp-scanner:
    build:
      context: ../..
      dockerfile: services/vcp_scanner/Dockerfile
      target: development
    volumes:
      - ../../src:/app/src:ro
      - ../../services:/app/services:ro
      - ../../data:/app/data
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "5112", "--reload"]
    restart: unless-stopped

  # Signal Engine - Development
  signal-engine:
    build:
      context: ../..
      dockerfile: services/signal_engine/Dockerfile
      target: development
    environment:
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
    volumes:
      - ../../src:/app/src:ro
      - ../../services:/app/services:ro
      - ../../data:/app/data
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "5113", "--reload"]
    restart: unless-stopped

  # Chatbot - Development
  chatbot:
    build:
      context: ../..
      dockerfile: services/chatbot/Dockerfile
      target: development
    environment:
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
    volumes:
      - ../../src:/app/src:ro
      - ../../services:/app/services:ro
      - ../../data:/app/data
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "5114", "--reload"]
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Background Processing (Development)
  # ---------------------------------------------------------------------------

  # Celery Worker - Development
  celery-worker:
    build:
      context: ../..
      dockerfile: Dockerfile.celery
      target: development
    environment:
      PYTHONPATH: /app
      KIWOOM_APP_KEY: ${KIWOOM_APP_KEY:-}
      KIWOOM_SECRET_KEY: ${KIWOOM_SECRET_KEY:-}
      KIWOOM_BASE_URL: ${KIWOOM_BASE_URL:-https://api.kiwoom.com}
      KIWOOM_WS_URL: ${KIWOOM_WS_URL:-wss://api.kiwoom.com:10000/api/dostk/websocket}
    volumes:
      - ../../src:/app/src:ro
      - ../../services:/app/services:ro
      - ../../tasks:/app/tasks:ro
      - ../../data:/app/data
    command: [
      "celery", "-A", "tasks.celery_app", "worker",
      "--loglevel=debug",
      "--concurrency=2"
    ]
    restart: unless-stopped

  # Celery Beat - Development
  celery-beat:
    build:
      context: ../..
      dockerfile: Dockerfile.celery
      target: development
    environment:
      PYTHONPATH: /app
      KIWOOM_APP_KEY: ${KIWOOM_APP_KEY:-}
      KIWOOM_SECRET_KEY: ${KIWOOM_SECRET_KEY:-}
      KIWOOM_BASE_URL: ${KIWOOM_BASE_URL:-https://api.kiwoom.com}
      KIWOOM_WS_URL: ${KIWOOM_WS_URL:-wss://api.kiwoom.com:10000/api/dostk/websocket}
    volumes:
      - ../../src:/app/src:ro
      - ../../services:/app/services:ro
      - ../../tasks:/app/tasks:ro
      - ../../data:/app/data
    command: ["celery", "-A", "tasks.celery_app", "beat", "--loglevel=debug"]
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Frontend (Development)
  # ---------------------------------------------------------------------------

  frontend:
    build:
      context: ../../frontend
      dockerfile: Dockerfile.frontend.dev
    environment:
      # 로컬 개발용: 호스트 머신 API 연결
      NEXT_PUBLIC_API_URL: "http://localhost:5111"
      NEXT_PUBLIC_WS_URL: "ws://localhost:5111"
    volumes:
      - ../../frontend:/app
      - /app/node_modules  # Prevent overwriting host node_modules
    restart: unless-stopped

networks:
  ralph_stock_network:
    external: true  # 프로젝트 루트의 네트워크 사용

