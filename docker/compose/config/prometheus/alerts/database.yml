# Database Alert 규칙

groups:
  - name: database
    interval: 30s
    rules:
      # PostgreSQL 연결 과다
      - alert: PostgresTooManyConnections
        expr: |
          (
            sum(pg_stat_database_numbackends) without (datname)
            /
            pg_settings_max_connections
          ) * 100 > 80
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "PostgreSQL 연결 과다"
          description: "연결 수가 최대의 80% 이상입니다 (현재: {{ $value }}%)"
          runbook: "https://docs.ralphpark.com/runbooks/postgres-connections"

      # PostgreSQL 연결 거의 꽉 참
      - alert: PostgresConnectionPoolExhausted
        expr: |
          (
            sum(pg_stat_database_numbackends) without (datname)
            /
            pg_settings_max_connections
          ) * 100 > 90
        for: 2m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "PostgreSQL 연결풸 부족"
          description: "연결 수가 최대의 90% 이상입니다 (현재: {{ $value }}%)"

      # PostgreSQL 쿼리 성능 저하
      - alert: PostgresSlowQueries
        expr: |
          avg(rate(pg_stat_statements_mean_exec_time_seconds[5m])) > 1
        for: 10m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "PostgreSQL 느린 쿼리"
          description: "평균 쿼리 실행 시간이 1초 이상입니다 (현재: {{ $value }}s)"
          runbook: "https://docs.ralphpark.com/runbooks/slow-queries"

      # PostgreSQL Cache Hit Ratio 낮음
      - alert: PostgresLowCacheHitRatio
        expr: |
          (
            sum(pg_stat_database_blks_hit)
            /
            (sum(pg_stat_database_blks_hit) + sum(pg_stat_database_blks_read))
          ) * 100 < 95
        for: 10m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "PostgreSQL 캐시 히트율 낮음"
          description: "캐시 히트율이 95% 미만입니다 (현재: {{ $value }}%)"
          runbook: "https://docs.ralphpark.com/runbooks/cache-hit-ratio"

      # PostgreSQL 데이터베이스 크기 급증
      - alert: PostgresDatabaseGrowingFast
        expr: |
          (
            pg_database_size_bytes{datname="ralph_stock"}
            -
            pg_database_size_bytes{datname="ralph_stock"} offset 1d
          ) / (1024*1024*1024) > 10
        for: 5m
        labels:
          severity: info
          component: database
        annotations:
          summary: "PostgreSQL 데이터베이스 급증"
          description: "데이터베이스 크기가 하루에 10GB 이상 증가했습니다."

      # PostgreSQL 복제 지연 (Standby가 있는 경우)
      - alert: PostgresReplicationLag
        expr: |
          pg_replication_lag_seconds > 30
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "PostgreSQL 복제 지연"
          description: "복제 지연이 30초 이상입니다 (현재: {{ $value }}s)"
          runbook: "https://docs.ralphpark.com/runbooks/replication-lag"

      # Redis 메모리 사용량 높음
      - alert: RedisHighMemoryUsage
        expr: |
          (
            redis_memory_used_bytes
            /
            redis_memory_max_bytes
          ) * 100 > 80
        for: 10m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "Redis 메모리 사용량 높음"
          description: "Redis 메모리 사용량이 80% 이상입니다 (현재: {{ $value }}%)"

      # Redis 연결 과다
      - alert: RedisTooManyConnections
        expr: |
          redis_connected_clients / redis_config_maxclients * 100 > 80
        for: 5m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "Redis 연결 과다"
          description: "Redis 연결 수가 최대의 80% 이상입니다 (현재: {{ $value }}%)"

      # Redis 키 개수 급증
      - alert: RedisKeyCountSpike
        expr: |
          (
            redis_db_keys
            -
            redis_db_keys offset 1h
          ) / redis_db_keys * 100 > 50
        for: 5m
        labels:
          severity: info
          component: cache
        annotations:
          summary: "Redis 키 개수 급증"
          description: "Redis 키 개수가 1시간 만에 50% 이상 증가했습니다."

      # Redis Eviction 발생
      - alert: RedisEvictingKeys
        expr: |
          rate(redis_evicted_keys_total[5m]) > 0
        for: 5m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "Redis Key Eviction 발생"
          description: "메모리 부족으로 키가 삭제되고 있습니다 ({{ $value }}/s)"
          runbook: "https://docs.ralphpark.com/runbooks/redis-eviction"
