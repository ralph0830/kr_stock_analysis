# API Gateway Service
# Port: 5111

services:
  api-gateway:
    build:
      context: ../../../
      dockerfile: services/api_gateway/Dockerfile
      target: development
    image: api-gateway:dev
    container_name: api-gateway
    restart: unless-stopped
    ports:
      - "5111:5111"
    environment:
      TZ: Asia/Seoul
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/ralph_stock
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/1
      CELERY_RESULT_BACKEND: redis://redis:6379/2
      VCP_SCANNER_URL: http://vcp-scanner:5112
      SIGNAL_ENGINE_URL: http://signal-engine:5113
      CHATBOT_SERVICE_URL: http://chatbot:5114
      DAYTRADING_SCANNER_URL: http://daytrading-scanner:5115
      # Kiwoom API (실시간 데이터)
      KIWOOM_APP_KEY: ${KIWOOM_APP_KEY}
      KIWOOM_SECRET_KEY: ${KIWOOM_SECRET_KEY}
      KIWOOM_BASE_URL: ${KIWOOM_BASE_URL:-https://api.kiwoom.com}
      KIWOOM_WS_URL: ${KIWOOM_WS_URL:-wss://api.kiwoom.com:10000/api/dostk/websocket}
      # Mock API 사용 안 함 (실제 Kiwoom API 사용)
      KIWOOM_API_URL: ""
      # Kiwoom REST API 사용 안 함 - DB에서 데이터 가져오기
      USE_KIWOOM_REST: "false"
      # PYTHONPATH for src module imports
      PYTHONPATH: /app:/app/services/api_gateway
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      db-init:
        condition: service_completed_successfully
    command: ["uvicorn", "services.api_gateway.main:app", "--host", "0.0.0.0", "--port", "5111", "--reload"]
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:5111/health').raise_for_status()"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3
    networks:
      - ralph-network
