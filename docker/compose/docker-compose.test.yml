# docker/compose/docker-compose.test.yml
# Ralph Stock - Docker Compose 테스트 환경
# 사용법: docker compose -f docker/compose/docker-compose.test.yml up --abort-on-container-exit

services:
  # ---------------------------------------------------------------------------
  # Infrastructure Services (Test)
  # ---------------------------------------------------------------------------

  # PostgreSQL - Test with in-memory settings
  postgres:
    image: timescale/timescaledb:latest-pg15
    environment:
      POSTGRES_DB: ralph_stock_test
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      TZ: Asia/Seoul
    ports:
      - "5433:5432"
    tmpfs:
      - /home/postgresql/data  # 테스트용 메모리 DB (속도 우선)
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - ralph_stock_network

  # Redis - Test
  redis:
    image: redis:7-alpine
    command: redis-server --save "" --appendonly no  # 테스트용 비영구 모드
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
    networks:
      - ralph_stock_network

  # ---------------------------------------------------------------------------
  # Test Services
  # ---------------------------------------------------------------------------

  # 테스트 실행기
  test-runner:
    build:
      context: ../..
      dockerfile: services/api_gateway/Dockerfile
      target: development
    container_name: ralph_stock_test_runner
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/ralph_stock_test
      REDIS_URL: redis://redis:6379/0
      TEST_ENV: docker
      TZ: Asia/Seoul
    volumes:
      - ../../tests:/app/tests:ro
      - ../../src:/app/src:ro
      - ../../services:/app/services:ro
    command: ["pytest", "tests/", "-v", "--tb=short", "--cov=src", "--cov-report=term-missing"]
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ralph_stock_network

  # E2E 테스트용 최소 서비스 (필요한 것만)
  api-gateway:
    build:
      context: ../..
      dockerfile: services/api_gateway/Dockerfile
      target: development
    container_name: ralph_stock_api_gateway_test
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/ralph_stock_test
      REDIS_URL: redis://redis:6379/0
      VCP_SCANNER_URL: http://vcp-scanner:5112
      SIGNAL_ENGINE_URL: http://signal-engine:5113
      CHATBOT_SERVICE_URL: http://chatbot:5114
      TZ: Asia/Seoul
    ports:
      - "5111:5111"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ralph_stock_network

  vcp-scanner:
    build:
      context: ../..
      dockerfile: services/vcp_scanner/Dockerfile
      target: development
    container_name: ralph_stock_vcp_scanner_test
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/ralph_stock_test
      REDIS_URL: redis://redis:6379/0
      TZ: Asia/Seoul
    ports:
      - "5112:5112"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ralph_stock_network

  signal-engine:
    build:
      context: ../..
      dockerfile: services/signal_engine/Dockerfile
      target: development
    container_name: ralph_stock_signal_engine_test
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/ralph_stock_test
      REDIS_URL: redis://redis:6379/0
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      TZ: Asia/Seoul
    ports:
      - "5113:5113"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ralph_stock_network

  chatbot:
    build:
      context: ../..
      dockerfile: services/chatbot/Dockerfile
      target: development
    container_name: ralph_stock_chatbot_test
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/ralph_stock_test
      REDIS_URL: redis://redis:6379/0
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      TZ: Asia/Seoul
    ports:
      - "5114:5114"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ralph_stock_network

networks:
  ralph_stock_network:
    driver: bridge
