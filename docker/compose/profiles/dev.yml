# Development Profile Overrides
# =============================================================================
# 개발 환경용 오버라이드 설정
# 특징: 핫 리로드, 소스 마운트, 디버깅 모드
# =============================================================================

services:
  # API Gateway - Development (hot reload)
  api-gateway:
    build:
      target: development
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app:/app/services/api_gateway
    volumes:
      - ../../src:/app/src:ro
      - ../../services/api_gateway:/app/services/api_gateway:ro
    command: ["sh", "-c", "PYTHONPATH=/app:/app/services/api_gateway uvicorn main:app --host 0.0.0.0 --port 5111 --reload"]
    # Phase 3: 리소스 제한 (CPU 1.0, Memory 2GB)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 256M
    # Phase 3: 로그 파일 크기 제한
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 3
    develop:
      watch:
        - path: ./services/api_gateway
          action: sync
          target: /app/services/api_gateway
        - path: ./src
          action: sync
          target: /app/src

  # VCP Scanner - Development (hot reload)
  vcp-scanner:
    build:
      target: development
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app/services/vcp_scanner
    volumes:
      - ../../src:/app/src:ro
      - ../../services/vcp_scanner:/app/services/vcp_scanner:ro
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "5112", "--reload"]
    # Phase 3: 리소스 제한
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
        reservations:
          cpus: '0.1'
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 3

  # Signal Engine - Development (hot reload)
  signal-engine:
    build:
      target: development
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app/services/signal_engine
    volumes:
      - ../../src:/app/src:ro
      - ../../services/signal_engine:/app/services/signal_engine:ro
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "5113", "--reload"]
    # Phase 3: 리소스 제한
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
        reservations:
          cpus: '0.1'
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 3

  # Daytrading Scanner - Development (hot reload)
  daytrading-scanner:
    build:
      target: development
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app/services/daytrading_scanner
    volumes:
      - ../../src:/app/src:ro
      - ../../services/daytrading_scanner:/app/services/daytrading_scanner:ro
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "5115", "--reload"]
    # Phase 3: 리소스 제한
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
        reservations:
          cpus: '0.1'
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 3

  # Chatbot - Development (hot reload)
  chatbot:
    build:
      target: development
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app/services/chatbot
    volumes:
      - ../../src:/app/src:ro
      - ../../services/chatbot:/app/services/chatbot:ro
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "5114", "--reload"]
    # Phase 3: 리소스 제한
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
        reservations:
          cpus: '0.1'
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 3

  # Frontend - Development (hot reload)
  frontend:
    ports:
      - "5110:3000"
    # 환경 변수를 비워서 코드에서 동적으로 결정 (외부 도메인 지원)
    environment:
      - NEXT_PUBLIC_API_URL=
      - NEXT_PUBLIC_WS_URL=
    volumes:
      - ../../frontend:/app
      - /app/node_modules
      - /app/.next

  # Celery Worker - Development
  celery-worker:
    build:
      target: development
    command: ["celery", "-A", "tasks.celery_app", "worker", "--loglevel=info"]
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
    volumes:
      - ../../src:/app/src:ro
      - ../../tasks:/app/tasks:ro
    # Phase 3: 리소스 제한
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 3

  # Celery Beat - Development
  celery-beat:
    build:
      target: development
    command: ["celery", "-A", "tasks.celery_app", "beat", "--loglevel=info"]
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
    volumes:
      - ../../src:/app/src:ro
      - ../../tasks:/app/tasks:ro
    # Phase 3: 리소스 제한
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.05'
          memory: 64M
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 3

  # Flower - Development (enable debug UI)
  flower:
    environment:
      - FLOWER_DEBUG=1
    # Phase 3: 리소스 제한
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.05'
          memory: 64M
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 3
