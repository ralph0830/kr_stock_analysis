[pytest]
# Pytest Configuration File
# 테스트 실행 설정 및 timeout 관리 (성능 최적화)

# 테스트 파일 검색 패턴
python_files = test_*.py *_test.py
python_classes = Test*
python_functions = test_*

# 테스트 폴더
testpaths = tests

# ============================================================================
# 타임아웃 설정 (성능 최적화)
# ============================================================================

# 기본 타임아웃 설정 (초)
# - 전체 테스트 세션: 300초 (5분)
# - 개별 테스트: 15초 (단위 테스트 기준)
# 너무 길어지는 테스트를 방지하기 위한 기본값
timeout = 15

# 타임아웃 메서드: 'thread' (기본) 또는 'signal'
# - thread: Windows 호환, 모든 플랫폼 동작
# - signal: Unix/Linux에서 더 정확하지만 Windows 미지원
timeout_method = thread

# ============================================================================
# Asyncio 설정
# ============================================================================

# asyncio 모드 설정 (pytest-asyncio)
asyncio_mode = auto

# ============================================================================
# 마커 등록
# ============================================================================

markers =
    fast: 빠른 테스트 (단위 테스트, mock만 사용, 5초 이내)
    slow: 느린 테스트 (통합 테스트, DB 연동 등)
    integration: 통합 테스트 (외부 서비스/DB 필요)
    unit: 단위 테스트 (mock만 사용, 외부 의존성 없음)
    timeout(n): 개별 테스트 타임아웃 설정 (초 단위)

# ============================================================================
# 추가 옵션 (성능 최적화)
# ============================================================================

#覆盖率 설정 (선택)
addopts =
    # 마커 미사용 경고 무시
    -W ignore::pytest.PytestUnraisableExceptionWarning
    # 타임아웃 활성화 (기본 15초)
    --timeout=15
    # 실패한 테스트 즉시 표시 (분석 편의성)
    -rf
    # 테스트 진행률 표시 (대규모 테스트용)
    # --tb=short  # traceback 간소화 (속도 향상)

# ============================================================================
# 로그 설정
# ============================================================================

log_cli = false
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

# ============================================================================
# 커버리지 설정 (pytest-cov) - 선택적 사용
# ============================================================================

# addopts = --cov=src --cov-report=html --cov-report=term

# 최소 커버리지 요구사항 (선택)
# cov-fail-under = 80

# ============================================================================
# 병렬 실행 설정 (pytest-xdist) - 선택적 사용
# ============================================================================

# 병렬 실행 활성화 (CPU 코어 수에 맞춰 자동 설정)
# -n auto: 자동으로 worker 개수 설정 (CPU 코어 수)
# -n 4: 4개 worker 사용
# -n logical: 논리 코어 수 만큼 worker 생성
# addopts = -n auto

# 주의: xdist 사용 시 일부 fixture가 동작하지 않을 수 있음
# (scope='session' fixture 등은 정상 동작)

# ============================================================================
# 테스트 실행 예시
# ============================================================================

# 1. 빠른 테스트만 실행 (단위 테스트):
#    uv run pytest -m fast -v
#
# 2. 통합 테스트 제외하고 실행:
#    uv run pytest -m "not integration" -v
#
# 3. 타임아웃 30초로 늘려서 실행:
#    uv run pytest --timeout=30 -v
#
# 4. 병렬 실행 (4개 worker):
#    uv run pytest -n 4 -v
#
# 5. 개별 테스트 파일 실행:
#    uv run pytest tests/unit/kiwoom/test_websocket.py -v
#
# 6. 느린 테스트만 실행:
#    uv run pytest -m slow -v
