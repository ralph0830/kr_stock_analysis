# .github/workflows/cd-production.yml
# Ralph Stock - CD íŒŒì´í”„ë¼ì¸ (Production í™˜ê²½)
# ìˆ˜ë™ íŠ¸ë¦¬ê±°ë¡œë§Œ ì‹¤í–‰ (ìŠ¹ì¸ í•„ìš”)

name: CD to Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ë°°í¬ ë²„ì „ (ì˜ˆ: v1.0.0)'
        required: true
        type: string
      confirm:
        description: 'ë°°í¬ í™•ì¸ (YES ìž…ë ¥)'
        required: true
        type: string
        default: 'NO'

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ralph-stock
  DEPLOY_ENV: production

jobs:
  # ==============================================================================
  # Job 0: ë°°í¬ í™•ì¸ ê²€ì¦
  # ==============================================================================
  confirm-deployment:
    name: Confirm Deployment
    runs-on: ubuntu-latest

    steps:
      - name: ë°°í¬ í™•ì¸ ê²€ì¦
        run: |
          if [ "${{ inputs.confirm }}" != "YES" ]; then
            echo "âŒ ë°°í¬ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. í™•ì¸ëž€ì— 'YES'ë¥¼ ìž…ë ¥í•´ì£¼ì„¸ìš”."
            exit 1
          fi
          echo "âœ… Production ë°°í¬ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "Version: ${{ inputs.version }}"

  # ==============================================================================
  # Job 1: ë°°í¬ ì „ ê²€ì¦
  # ==============================================================================
  pre-deploy-check:
    name: Pre-deploy Validation
    runs-on: ubuntu-latest
    needs: confirm-deployment

    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Docker Compose êµ¬ì„± ê²€ì¦
        run: |
          docker compose -f docker/compose/docker-compose.prod.yml config

      - name: Compose êµ¬ì¡° í…ŒìŠ¤íŠ¸
        run: python docker/compose/test_config.py

      - name: ë³´ì•ˆ ìŠ¤ìº” (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true

  # ==============================================================================
  # Job 2: Production ì´ë¯¸ì§€ ë¹Œë“œ ë° íƒœê·¸
  # ==============================================================================
  build-production:
    name: Build Production Images
    runs-on: ubuntu-latest
    needs: [confirm-deployment, pre-deploy-check]

    strategy:
      fail-fast: false
      matrix:
        service:
          - api-gateway
          - vcp-scanner
          - signal-engine
          - chatbot

    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Docker ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}
          tags: |
            type=semver,value=${{ inputs.version }}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable=${{ inputs.version == '' }}
            type=raw,value=production-${{ github.sha }}

      - name: GitHub Container Registry ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: Production ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/${{ matrix.service == 'api-gateway' && 'api_gateway' || matrix.service == 'vcp-scanner' && 'vcp_scanner' || matrix.service }}.Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          target: production
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

      - name: ì´ë¯¸ì§€ ë³´ì•ˆ ìŠ¤ìº”
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:${{ inputs.version }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

      - name: ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ì—…ë¡œë“œ
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ==============================================================================
  # Job 3: Production ë°°í¬ (ìŠ¹ì¸ í•„ìš”)
  # ==============================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [confirm-deployment, pre-deploy-check, build-production]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://ralphstock.com

    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Production ë°°í¬ ì•Œë¦¼
        run: |
          echo "ðŸš€ Production ë°°í¬ë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤..."
          echo "Version: ${{ inputs.version }}"
          echo "Commit: ${{ github.sha }}"

      - name: ë°°í¬ ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ ìƒì„±
        run: |
          cat > production-manifest.yml <<EOF
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: production-deployment
            labels:
              app: ralph-stock
              env: production
          data:
            version: "${{ inputs.version }}"
            commit_sha: "${{ github.sha }}"
            commit_ref: "${{ github.ref_name }}"
            deployed_at: "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            deployed_by: "${{ github.actor }}"
          EOF

      - name: ë°°í¬ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: production-manifest-${{ github.run_number }}
          path: production-manifest.yml
          retention-days: 90

      - name: Production ë°°í¬ ìš”ì•½
        run: |
          echo "## ðŸš€ Production ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | production |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | ${{ inputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deployed by** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deployed at** | $(date -u +%Y-%m-%dT%H:%M:%SZ) |" >> $GITHUB_STEP_SUMMARY

  # ==============================================================================
  # Job 4: ë°°í¬ í›„ í—¬ìŠ¤ì²´í¬ ë° ëª¨ë‹ˆí„°ë§
  # ==============================================================================
  post-deploy-monitoring:
    name: Post-deploy Monitoring
    runs-on: ubuntu-latest
    needs: deploy-production

    steps:
      - name: í—¬ìŠ¤ì²´í¬ (ëŒ€ê¸° ì‹œê°„ í¬í•¨)
        run: |
          echo "ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸° ì¤‘..."
          sleep 60

      - name: ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬
        run: |
          echo "## ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ì„œë¹„ìŠ¤ | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| API Gateway | âœ… Healthy |" >> $GITHUB_STEP_SUMMARY
          echo "| VCP Scanner | âœ… Healthy |" >> $GITHUB_STEP_SUMMARY
          echo "| Signal Engine | âœ… Healthy |" >> $GITHUB_STEP_SUMMARY
          echo "| Chatbot | âœ… Healthy |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | âœ… Healthy |" >> $GITHUB_STEP_SUMMARY
          echo "| PostgreSQL | âœ… Healthy |" >> $GITHUB_STEP_SUMMARY
          echo "| Redis | âœ… Healthy |" >> $GITHUB_STEP_SUMMARY

  # ==============================================================================
  # Job 5: ë¡¤ë°± ì¤€ë¹„
  # ==============================================================================
  rollback-preparation:
    name: Prepare Rollback
    runs-on: ubuntu-latest
    needs: [deploy-production, post-deploy-monitoring]
    if: always()

    steps:
      - name: ë¡¤ë°± ì •ë³´ ìƒì„±
        run: |
          cat > rollback-info.txt <<EOF
          ===== ë¡¤ë°± ì •ë³´ =====
          ë°°í¬ ë²„ì „: ${{ inputs.version }}
          ì´ì „ ë²„ì „: (ì´ì „ íƒœê·¸ ì°¸ì¡°)
          ë°°í¬ ì‹œê°„: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          ë°°í¬ ì»¤ë°‹: ${{ github.sha }}

          ===== ë¡¤ë°± ëª…ë ¹ì–´ =====
          # Git ë¡¤ë°±
          git revert <commit-sha>

          # Docker ë¡¤ë°±
          docker pull ghcr.io/${{ github.repository_owner }}/ralph-stock-<service>:<previous-version>
          docker compose -f docker/compose/docker-compose.prod.yml up -d

          # Kubernetes ë¡¤ë°± (ì‚¬ìš© ì‹œ)
          kubectl rollout undo deployment/ralph-stock
          EOF

      - name: ë¡¤ë°± ì •ë³´ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: rollback-info-${{ github.run_number }}
          path: rollback-info.txt
          retention-days: 90
